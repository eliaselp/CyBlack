{% extends base %}

{% block contenido %}
<div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden">
    {% if urls or filtros%}
        <!-- Filtros Avanzados - Diseño Profesional con Soporte para Tema Claro/Oscuro -->
        <div class="p-6 border-b border-gray-200 dark:border-gray-700 bg-gradient-to-r from-gray-50 to-gray-100 dark:from-gray-800 dark:to-gray-900">
            <div class="mb-4">
                <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                    </svg>
                    Filtros Avanzados
                </h3>
                <p class="text-sm text-gray-600 dark:text-gray-300 mt-1">Filtre las URLs maliciosas según múltiples criterios</p>
            </div>

            <form id="filtrosForm" class="space-y-4" action="{% url 'aplicar_filtros' %}" method="POST">
                {% csrf_token %}
                <!-- Búsqueda general -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="busquedaGeneral" class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1">Búsqueda general</label>
                        <div class="relative rounded-md shadow-sm">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400 dark:text-gray-500">
                                <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path>
                                </svg>
                            </div>
                            <input type="text" id="busquedaGeneral" name="busquedaGeneral" 
                                value="{{ filtros.busquedaGeneral|default:'' }}"
                                class="block w-full pl-10 pr-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-500" 
                                placeholder="URL, IP, descripción...">
                        </div>
                    </div>
                    
                    <!-- Filtros de URL -->
                    <div>
                        <label for="filtroProtocolo" class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1">Protocolo</label>
                        <select id="filtroProtocolo" name="protocolo" 
                                class="mt-1 block w-full pl-3 pr-10 py-2 text-base border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                            <option value="">Todos los protocolos</option>
                            {% for protocolo in PROTOCOLO_CHOICES %}
                                <option value="{{ protocolo.0 }}" {% if filtros.protocolo == protocolo.0|stringformat:"s" %}selected{% endif %}>{{ protocolo.1 }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div>
                        <label for="filtroPuerto" class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1">Puerto</label>
                        <input type="number" id="filtroPuerto" name="puerto" 
                            value="{{ filtros.puerto|default:'' }}"
                            class="mt-1 block w-full pl-3 pr-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-500" 
                            placeholder="Ej: 80, 443">
                    </div>
                </div>

                <!-- Segunda fila de filtros -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="filtroObjetivo" class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1">Objetivo</label>
                        <select id="filtroObjetivo" name="objetivo" 
                                class="mt-1 block w-full pl-3 pr-10 py-2 text-base border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                            <option value="">Todos los objetivos</option>
                            {% for objetivo in OBJETIVO_CHOICES %}
                                <option value="{{ objetivo.0 }}" {% if filtros.objetivo == objetivo.0|stringformat:"s" %}selected{% endif %}>{{ objetivo.1 }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div>
                        <label for="filtroMetodo" class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1">Método URL</label>
                        <select id="filtroMetodo" name="metodo" 
                                class="mt-1 block w-full pl-3 pr-10 py-2 text-base border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                            <option value="">Todos los métodos</option>
                            {% for metodo in METODO_CHOICES %}
                                <option value="{{ metodo.0 }}" {% if filtros.metodo == metodo.0|stringformat:"s" %}selected{% endif %}>{{ metodo.1 }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div>
                        <label for="filtroImpacto" class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1">Impacto Legal</label>
                        <select id="filtroImpacto" name="impacto" 
                                class="mt-1 block w-full pl-3 pr-10 py-2 text-base border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                            <option value="">Todos los impactos</option>
                            {% for impacto in IMPACTO_LEGAL_CHOICES %}
                                <option value="{{ impacto.0 }}" {% if filtros.impacto == impacto.0|stringformat:"s" %}selected{% endif %}>{{ impacto.1 }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- Tercera fila de filtros -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="filtroMetodoDeteccion" class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1">Método Detección</label>
                        <select id="filtroMetodoDeteccion" name="metodo_deteccion" 
                                class="mt-1 block w-full pl-3 pr-10 py-2 text-base border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                            <option value="">Todos los métodos</option>
                            {% for metodo in METODO_DETECCION_CHOICES %}
                                <option value="{{ metodo.0 }}" {% if filtros.metodo_deteccion == metodo.0|stringformat:"s" %}selected{% endif %}>{{ metodo.1 }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div>
                        <label for="filtroEntidad" class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1">Entidad Reportante</label>
                        <select id="filtroEntidad" name="entidad" 
                                class="mt-1 block w-full pl-3 pr-10 py-2 text-base border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                            <option value="">Todas las entidades</option>
                            {% for id,nombre in ENTIDADES_CHOICES %}
                                <option value="{{ id }}" {% if filtros.entidad == nombre %}selected{% endif %}>{{ nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div>
                        <label for="filtroFechaInicio" class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1">Rango de Fechas</label>
                        <div class="flex space-x-2">
                            <input type="date" id="filtroFechaInicio" name="fecha_inicio" 
                                value="{{ filtros.fecha_inicio|default:'' }}"
                                class="mt-1 block w-full pl-3 pr-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                            <span class="flex items-center text-gray-500 dark:text-gray-400">a</span>
                            <input type="date" id="filtroFechaFin" name="fecha_fin" 
                                value="{{ filtros.fecha_fin|default:'' }}"
                                class="mt-1 block w-full pl-3 pr-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                        </div>
                    </div>
                </div>

                <!-- Fila de botones - Modificado para responsive -->
                <div class="flex flex-col md:flex-row justify-between pt-2 space-y-2 md:space-y-0">
                    <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 w-full md:w-auto">
                        <a href="{% url 'lista_negra' %}" type="button" 
                                class="inline-flex items-center justify-center px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200 w-full sm:w-auto">
                            <svg class="-ml-1 mr-2 h-5 w-5 text-gray-500 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            Restablecer
                        </a>
                        
                        {% if urls %}
                            <button type="button" onclick="openExportModal()"
                                    class="inline-flex items-center justify-center px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200 w-full sm:w-auto">
                                <svg class="-ml-1 mr-2 h-5 w-5 text-gray-500 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Exportar
                            </button>
                        {% endif %}
                    </div>
                    <button type="submit" 
                            class="inline-flex items-center justify-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200 w-full md:w-auto">
                        <svg class="-ml-1 mr-2 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                        </svg>
                        Aplicar Filtros
                    </button>
                </div>
            </form>
        </div>
        <!-- Tabla Simplificada -->
        <div class="overflow-x-auto">
            <table id="urlsTable" class="w-full">
                <thead class="bg-gray-50 dark:bg-gray-700">
                    <tr>
                        <th class="w-24 px-4 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">Protocolo</th>
                        <th class="min-w-[300px] px-4 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">URL</th>
                        <th class="w-32 px-4 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">IP</th>
                        <th class="w-20 px-4 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">Puerto</th>
                        <th class="w-40 px-4 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">Objetivo</th>
                        <th class="w-40 px-4 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">Método</th>
                        <th class="w-32 px-4 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">Impacto</th>
                        <th class="w-32 px-4 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">Acciones</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                    {% for url in urls %}
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-900 transition-colors">
                        <!-- Protocolo -->
                        <td class="w-24 px-4 py-3 text-sm font-medium text-gray-800 dark:text-gray-200 whitespace-nowrap">
                            {{ url.get_protocolo_display }}
                        </td>
                        
                        <!-- URL -->
                        <td class="min-w-[300px] px-4 py-3">
                            <div class="text-sm text-gray-600 dark:text-gray-300 font-mono truncate max-w-[300px]">
                                {{ url.url }}
                            </div>
                        </td>
                        
                        <!-- IP -->
                        <td class="w-32 px-4 py-3 text-sm text-gray-600 dark:text-gray-300 font-mono">
                            {{ url.ip|default:"-" }}
                        </td>
                        
                        <!-- Puerto -->
                        <td class="w-20 px-4 py-3 text-sm text-gray-600 dark:text-gray-300 text-center">
                            {{ url.puerto }}
                        </td>
                        
                        <!-- Objetivo -->
                        <td class="w-40 px-4 py-3 text-sm text-gray-600 dark:text-gray-300">
                            {{ url.get_objetivo_display|default:"-" }}
                        </td>
                        
                        <!-- Método -->
                        <td class="w-40 px-4 py-3 text-sm">
                            <span class="px-2 py-1 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-100 rounded-full text-xs whitespace-nowrap">
                                {{ url.get_metodo_display|default:"-" }}
                            </span>
                        </td>
                        
                        <!-- Impacto Legal -->
                        <td class="w-32 px-4 py-3 text-sm">
                            {% if url.impacto_legal == 'GRAVE' %}
                                <span class="px-2 py-1 bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-100 rounded-full text-xs whitespace-nowrap">Grave</span>
                            {% elif url.impacto_legal == 'MODERADO' %}
                                <span class="px-2 py-1 bg-orange-100 dark:bg-orange-900 text-orange-800 dark:text-orange-100 rounded-full text-xs whitespace-nowrap">Moderado</span>
                            {% elif url.impacto_legal == 'LEVE' %}
                                <span class="px-2 py-1 bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-100 rounded-full text-xs whitespace-nowrap">Leve</span>
                            {% else %}
                                <span class="px-2 py-1 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-300 rounded-full text-xs whitespace-nowrap">No definido</span>
                            {% endif %}
                        </td>
                        
                        <!-- Acciones -->
                        <td class="w-32 px-4 py-3 text-sm whitespace-nowrap">
                            <button onclick="showEvidenceModal('{{ url.id }}')" 
                                    class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 flex items-center group">
                                <span class="mr-1">Ver Detalles</span>
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                </svg>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <!-- Mensaje cuando no hay URLs -->
        <div class="p-12 text-center">
            <div class="max-w-md mx-auto">
                <svg class="mx-auto h-12 w-12 text-gray-400 dark:text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <h3 class="mt-2 text-lg font-medium dark:text-gray-200">No se encontraron direcciones URL</h3>
                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                    No se han encontrado direcciones URL maliciosas en el sistema. 
                    {% if filtro %}
                        <br>
                        Por favor, revise que los filtros sean correctos.
                    {% endif %}
                </p>
            </div>
        </div>
    {% endif %}
</div>

<!-- Modal para Detalles - Versión Mejorada -->
<div id="evidenceModal" class="hidden fixed inset-0 bg-gray-900/80 backdrop-blur-sm overflow-y-auto h-full w-full z-50 flex items-center justify-center p-4">
    <div class="relative bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-5xl max-h-[90vh] flex flex-col overflow-hidden">
        <!-- Modal Header - Mejorado -->
        <div class="flex justify-between items-center p-6 border-b border-gray-200 dark:border-gray-700 sticky top-0 bg-white dark:bg-gray-800 z-10">
            <div>
                <h3 class="text-2xl font-bold text-gray-800 dark:text-gray-100">Detalles de URL Maliciosa</h3>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1" id="modalUrlTitle"></p>
            </div>
            <button onclick="closeModal()" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                <svg class="w-6 h-6 text-gray-500 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <!-- Modal Content - Reorganizado -->
        <div class="p-6 overflow-y-auto flex-1">
            <!-- Pestañas para secciones -->
            <div class="border-b border-gray-200 dark:border-gray-700 mb-6">
                <nav class="-mb-px flex space-x-8">
                    <button id="tab-general" class="tab-button active border-b-2 border-blue-500 text-blue-600 dark:text-blue-400 dark:border-blue-400 py-4 px-4 font-medium">
                        Información General
                    </button>
                    <button id="tab-evidencias" class="tab-button border-b-2 border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 py-4 px-4 font-medium">
                        Evidencias
                    </button>
                    <button id="tab-accesos" class="tab-button border-b-2 border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 py-4 px-4 font-medium">
                        Intentos de Acceso
                    </button>
                </nav>
            </div>
            
            <!-- Contenido de pestañas -->
            <div id="tab-general-content" class="tab-content active">
                <!-- Tarjeta de información general mejorada -->
                <div class="bg-gray-50/50 dark:bg-gray-700/50 p-6 rounded-xl mb-6 border border-gray-200 dark:border-gray-700">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Grupo 1: URL e IP -->
                        <div class="space-y-1">
                            <h4 class="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">URL</h4>
                            <p class="text-base font-mono break-all dark:text-gray-200" id="modalUrl"></p>
                            
                            <h4 class="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mt-4">Dirección IP</h4>
                            <p class="text-base font-mono dark:text-gray-200" id="modalIp"></p>
                        </div>
                        
                        <!-- Grupo 2: Detalles técnicos -->
                        <div class="space-y-1">
                            <h4 class="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Protocolo</h4>
                            <p class="text-base dark:text-gray-200" id="modalProtocolo"></p>
                            
                            <h4 class="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mt-4">Puerto</h4>
                            <p class="text-base dark:text-gray-200" id="modalPuerto"></p>
                            
                            <h4 class="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mt-4">Impacto Legal</h4>
                            <p class="text-base" id="modalImpacto"></p>
                        </div>
                        
                        <!-- Grupo 3: Clasificación -->
                        <div class="space-y-1">
                            <h4 class="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Objetivo</h4>
                            <p class="text-base dark:text-gray-200" id="modalObjetivo"></p>
                            
                            <h4 class="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mt-4">Método</h4>
                            <p class="text-base dark:text-gray-200" id="modalMetodo"></p>
                        </div>
                        
                        <!-- Grupo 4: Fechas -->
                        <div class="space-y-1">
                            <h4 class="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Fecha Detección</h4>
                            <p class="text-base dark:text-gray-200" id="modalFechaDeteccion"></p>
                            
                            <h4 class="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mt-4">Último Acceso</h4>
                            <p class="text-base dark:text-gray-200" id="modalUltimoAcceso"></p>
                        </div>
                        
                        <!-- Grupo 5: Estadísticas -->
                        <div class="space-y-1">
                            <h4 class="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Total Accesos</h4>
                            <p class="text-base dark:text-gray-200" id="modalTotalAccesos"></p>
                            
                            <h4 class="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mt-4">Evidencias</h4>
                            <p class="text-base dark:text-gray-200" id="modalTotalEvidencias"></p>
                        </div>
                    </div>
                    
                    <!-- Descripción en ancho completo -->
                    <div class="mt-6">
                        <h4 class="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Descripción</h4>
                        <p class="text-base dark:text-gray-300 mt-2 bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700" id="modalDescripcion"></p>
                    </div>
                </div>
            </div>
            
            <!-- Contenido de pestaña de evidencias -->
            <div id="tab-evidencias-content" class="tab-content hidden">
                <div class="space-y-4" id="evidenciasSection">
                    <!-- Contenido dinámico de evidencias -->
                </div>
                
                <!-- Mensaje cuando no hay evidencias -->
                <div id="no-evidencias" class="hidden text-center py-12">
                    <svg class="mx-auto h-12 w-12 text-gray-400 dark:text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <h3 class="mt-2 text-lg font-medium dark:text-gray-200">No hay evidencias registradas</h3>
                    <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                        No se han encontrado evidencias técnicas para esta URL.
                    </p>
                </div>
            </div>
            
            <!-- Contenido de pestaña de accesos -->
            <div id="tab-accesos-content" class="tab-content hidden">
                <div class="space-y-4" id="accesosSection">
                    <!-- Contenido dinámico de accesos -->
                </div>
                
                <!-- Mensaje cuando no hay accesos -->
                <div id="no-accesos" class="hidden text-center py-12">
                    <svg class="mx-auto h-12 w-12 text-gray-400 dark:text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                    <h3 class="mt-2 text-lg font-medium dark:text-gray-200">No hay registros de acceso</h3>
                    <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                        No se han registrado intentos de acceso a esta URL.
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Modal Footer - Mejorado -->
        <div class="flex justify-between items-center p-4 border-t border-gray-200 dark:border-gray-700 sticky bottom-0 bg-white dark:bg-gray-800">
            <div class="text-sm text-gray-500 dark:text-gray-400">
                ID: <span class="font-mono dark:text-gray-300" id="modalId"></span>
            </div>
            <div class="space-x-3">
                <button onclick="closeModal()" class="px-5 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                    Cerrar
                </button>
            </div>
        </div>
    </div>
</div>


<!-- Modal para Exportación -->
<div id="exportModal" class="hidden fixed inset-0 bg-gray-900/80 backdrop-blur-sm overflow-y-auto h-full w-full z-50 flex items-center justify-center p-4">
    <div class="relative bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md flex flex-col overflow-hidden">
        <!-- Modal Header -->
        <div class="flex justify-between items-center p-6 border-b border-gray-200 dark:border-gray-700 sticky top-0 bg-white dark:bg-gray-800 z-10">
            <div>
                <h3 class="text-xl font-bold text-gray-800 dark:text-gray-100">Exportar Datos</h3>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Seleccione el formato de exportación</p>
            </div>
            <button onclick="closeExportModal()" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                <svg class="w-6 h-6 text-gray-500 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <!-- Modal Content -->
        <div class="p-6 overflow-y-auto flex-1">
            <div class="space-y-4">
                <div>
                    <label for="exportFilename" class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1">Nombre del archivo</label>
                    <input type="text" id="exportFilename" 
                           class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-500" 
                           placeholder="Ej: reporte_urls_maliciosas" value="reporte_urls_maliciosas">
                </div>
                
                <div>
                    <p class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2">Formato de exportación</p>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="exportTable('xlsx')" class="flex flex-col items-center justify-center p-4 border border-gray-200 dark:border-gray-700 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                            <svg class="w-8 h-8 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <span class="mt-2 text-sm font-medium dark:text-gray-200">Excel (XLSX)</span>
                        </button>
                        
                        <button onclick="exportTable('csv')" class="flex flex-col items-center justify-center p-4 border border-gray-200 dark:border-gray-700 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                            <svg class="w-8 h-8 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <span class="mt-2 text-sm font-medium dark:text-gray-200">CSV</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Modal Footer -->
        <div class="flex justify-end p-4 border-t border-gray-200 dark:border-gray-700 sticky bottom-0 bg-white dark:bg-gray-800">
            <button onclick="closeExportModal()" class="px-5 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                Cancelar
            </button>
        </div>
    </div>
</div>




<!-- Modal para Detalles Técnicos - Mejorado -->
<div id="technicalDetailsModal" class="hidden fixed inset-0 bg-gray-900/80 backdrop-blur-sm overflow-y-auto h-full w-full z-50 flex items-center justify-center p-4">
    <div class="relative bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-4xl max-h-[80vh] flex flex-col overflow-hidden">
        <div class="flex justify-between items-center p-6 border-b border-gray-200 dark:border-gray-700 sticky top-0 bg-white dark:bg-gray-800 z-10">
            <div>
                <h3 class="text-xl font-bold text-gray-800 dark:text-gray-100">Detalles Técnicos</h3>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Información técnica completa de la evidencia</p>
            </div>
            <button onclick="closeTechnicalDetailsModal()" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                <svg class="w-6 h-6 text-gray-500 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <div class="p-6 overflow-y-auto flex-1">
            <div class="relative">
                <button onclick="copyTechnicalDetails()" class="absolute top-2 right-2 z-10 p-2 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                    <svg class="w-5 h-5 text-gray-500 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path>
                    </svg>
                </button>
                <pre id="technicalDetailsText" class="p-4 bg-gray-50 dark:bg-gray-700 dark:text-gray-200 rounded-lg text-sm font-mono overflow-x-auto max-h-[60vh]"></pre>
            </div>
        </div>
        
        <div class="flex justify-end p-4 border-t border-gray-200 dark:border-gray-700 sticky bottom-0 bg-white dark:bg-gray-800">
            <button onclick="closeTechnicalDetailsModal()" class="px-5 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                Cerrar
            </button>
        </div>
    </div>
</div>

<script>
// Datos precargados desde el contexto de Django
const urlsData = JSON.parse('{{ urls_data_json|escapejs }}');

// Función para mostrar el modal con los detalles - Versión mejorada
function showEvidenceModal(urlId) {
    const modal = document.getElementById('evidenceModal');
    modal.classList.remove('hidden');
    document.body.classList.add('overflow-hidden');
    
    const urlData = urlsData.find(url => url.id == urlId);
    
    if (!urlData) {
        console.error('No se encontraron datos para la URL con ID:', urlId);
        return;
    }
    
    // Activar solo la pestaña de información general al abrir
    switchTab('general');
    
    // Actualizar información general
    document.getElementById('modalId').textContent = urlData.id;
    document.getElementById('modalUrlTitle').textContent = urlData.url;
    document.getElementById('modalUrl').textContent = urlData.url;
    document.getElementById('modalIp').textContent = urlData.ip || "-";
    document.getElementById('modalProtocolo').textContent = `${urlData.protocolo_display}`;
    document.getElementById('modalPuerto').textContent = urlData.puerto;
    
    // Impacto legal con estilo según gravedad
    const impactoElement = document.getElementById('modalImpacto');
    if (urlData.impacto === 'GRAVE') {
        impactoElement.innerHTML = '<span class="px-2 py-1 bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-100 rounded-full text-sm">Grave</span>';
    } else if (urlData.impacto === 'MODERADO') {
        impactoElement.innerHTML = '<span class="px-2 py-1 bg-orange-100 dark:bg-orange-900 text-orange-800 dark:text-orange-100 rounded-full text-sm">Moderado</span>';
    } else if (urlData.impacto === 'LEVE') {
        impactoElement.innerHTML = '<span class="px-2 py-1 bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-100 rounded-full text-sm">Leve</span>';
    } else {
        impactoElement.innerHTML = '<span class="px-2 py-1 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-300 rounded-full text-sm">No definido</span>';
    }
    
    document.getElementById('modalObjetivo').textContent = urlData.objetivo_display || "-";
    document.getElementById('modalMetodo').textContent = urlData.metodo_display || "-";
    document.getElementById('modalFechaDeteccion').textContent = urlData.fecha_deteccion;
    document.getElementById('modalUltimoAcceso').textContent = urlData.ultimo_acceso;
    document.getElementById('modalTotalAccesos').textContent = urlData.total_accesos;
    document.getElementById('modalTotalEvidencias').textContent = urlData.evidencias ? urlData.evidencias.length : 0;
    document.getElementById('modalDescripcion').textContent = urlData.descripcion || "No hay descripción disponible";
    
    // Generar contenido de evidencias
    const evidenciasSection = document.getElementById('evidenciasSection');
    const noEvidencias = document.getElementById('no-evidencias');
    evidenciasSection.innerHTML = '';
    
    if (urlData.evidencias && urlData.evidencias.length > 0) {
        noEvidencias.classList.add('hidden');
        
        urlData.evidencias.forEach((evidencia, index) => {
            const showDownloadBtn = evidencia.archivo;
            const hasTechnicalDetails = evidencia.datos_tecnicos && Object.keys(evidencia.datos_tecnicos).length > 0;
            
            const evidenciaHTML = `
                <div class="border rounded-xl overflow-hidden hover:shadow-md transition-shadow dark:border-gray-700">
                    <div class="${hasTechnicalDetails ? 'grid grid-cols-1 lg:grid-cols-2 divide-y lg:divide-y-0 lg:divide-x divide-gray-200 dark:divide-gray-700' : ''}">
                        <!-- Columna izquierda - Información básica -->
                        <div class="p-5">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h4 class="font-semibold text-gray-800 dark:text-gray-200">Evidencia #${index + 1}</h4>
                                    <div class="flex items-center mt-1">
                                        <span class="inline-block w-2 h-2 rounded-full bg-green-500 mr-2"></span>
                                        <span class="text-sm text-gray-600 dark:text-gray-300">Estado: Confirmada</span>
                                    </div>
                                </div>
                                <span class="text-xs px-2.5 py-1 rounded-full bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200">
                                    ${evidencia.metodo}
                                </span>
                            </div>
                            
                            <div class="mt-4 grid grid-cols-2 gap-4">
                                <div>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider">Institución</p>
                                    <p class="text-sm font-medium dark:text-gray-200 mt-1">${evidencia.institucion}</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider">Fecha</p>
                                    <p class="text-sm font-medium dark:text-gray-200 mt-1">${evidencia.fecha}</p>
                                </div>
                            </div>
                            
                            <div class="mt-4">
                                <p class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider">Descripción</p>
                                <p class="text-sm dark:text-gray-300 mt-1">${evidencia.descripcion || 'No hay descripción disponible'}</p>
                            </div>
                            
                            <div class="mt-4 flex flex-wrap gap-2">
                                ${showDownloadBtn ? `
                                <button onclick="window.open('${evidencia.archivo}', '_blank')" 
                                        class="flex items-center px-3 py-1.5 bg-green-50 hover:bg-green-100 dark:bg-green-900/50 dark:hover:bg-green-900 border border-green-200 dark:border-green-800 text-green-700 dark:text-green-200 rounded-lg text-sm transition-colors">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                    </svg>
                                    Descargar
                                </button>
                                ` : ''}
                                
                                
                            </div>
                        </div>
                        
                        <!-- Columna derecha - Detalles técnicos (solo si existen) -->
                        ${hasTechnicalDetails ? `
                        <div class="p-5 bg-gray-50 dark:bg-gray-800/50">
                            <div class="flex items-center justify-between mb-3">
                                <h5 class="text-sm font-semibold text-gray-700 dark:text-gray-300">Vista Previa Técnica</h5>
                            </div>
                            <div class="bg-white dark:bg-gray-900 p-3 rounded-lg border border-gray-200 dark:border-gray-700 max-h-60 overflow-y-auto">
                                <code class="text-xs font-mono dark:text-gray-300">${formatTechnicalPreview(evidencia.datos_tecnicos)}</code>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
            evidenciasSection.innerHTML += evidenciaHTML;
        });
    } else {
        noEvidencias.classList.remove('hidden');
    }
    
    // Generar contenido de accesos
    const accesosSection = document.getElementById('accesosSection');
    const noAccesos = document.getElementById('no-accesos');
    accesosSection.innerHTML = '';
    
    if (urlData.accesos && urlData.accesos.length > 0) {
        noAccesos.classList.add('hidden');
        
        const sortedAccesos = [...urlData.accesos].sort((a, b) => {
            if (a.institucion === "Anónima") return 1;
            if (b.institucion === "Anónima") return -1;
            return b.intentos - a.intentos;
        });
        
        sortedAccesos.forEach(acceso => {
            const accesoHTML = `
                <div class="border rounded-xl p-5 hover:shadow-md transition-shadow dark:border-gray-700">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-semibold text-gray-800 dark:text-gray-200">${acceso.institucion}</h4>
                            ${acceso.tipo !== "Desconocido" ? `
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">${acceso.tipo}</p>
                            ` : ''}
                        </div>
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200">
                            ${acceso.intentos} intento${acceso.intentos !== 1 ? 's' : ''}
                        </span>
                    </div>
                    
                    <div class="mt-4 grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider">Último intento</p>
                            <p class="text-sm font-medium dark:text-gray-200 mt-1">${acceso.ultimo_intento}</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider">Frecuencia</p>
                            <p class="text-sm font-medium dark:text-gray-200 mt-1">${calculateFrequency(acceso.intentos, urlData.fecha_deteccion)}</p>
                        </div>
                    </div>
                </div>
            `;
            accesosSection.innerHTML += accesoHTML;
        });
    } else {
        noAccesos.classList.remove('hidden');
    }
}

// Función para formatear vista previa técnica
function formatTechnicalPreview(data) {
    if (!data) return "No hay datos técnicos disponibles";
    
    try {
        const str = JSON.stringify(data, null, 2);
        return str.length > 300 ? str.substring(0, 300) + "..." : str;
    } catch (e) {
        return "Datos técnicos no formateables";
    }
}

// Función para calcular frecuencia de accesos
function calculateFrequency(intentos, fechaDeteccion) {
    const deteccionDate = new Date(fechaDeteccion);
    const now = new Date();
    const diffDays = Math.ceil((now - deteccionDate) / (1000 * 60 * 60 * 24));
    
    if (diffDays <= 0) return "Hoy";
    
    const freq = intentos / diffDays;
    if (freq > 1) return `${Math.round(freq)}/día`;
    if (freq > 0.1) return `${Math.round(freq * 10)/10}/día`;
    return `${Math.round(intentos / (diffDays/7))}/semana`;
}

// Función para copiar detalles técnicos
function copyTechnicalDetails() {
    const text = document.getElementById('technicalDetailsText').textContent;
    navigator.clipboard.writeText(text).then(() => {
        // Mostrar notificación de copiado
        const notification = document.createElement('div');
        notification.className = 'fixed bottom-4 right-4 px-4 py-2 bg-green-500 text-white rounded-lg shadow-lg text-sm';
        notification.textContent = '¡Copiado al portapapeles!';
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.classList.add('opacity-0', 'transition-opacity', 'duration-300');
            setTimeout(() => notification.remove(), 300);
        }, 2000);
    });
}

// Función para cambiar entre pestañas
function switchTab(tabName) {
    // Ocultar todos los contenidos y desactivar todos los botones
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
        content.classList.remove('active');
    });
    document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active', 'border-blue-500', 'text-blue-600', 'dark:text-blue-400', 'dark:border-blue-400');
        button.classList.add('border-transparent', 'text-gray-500', 'dark:text-gray-400');
    });
    
    // Mostrar el contenido seleccionado y activar el botón
    document.getElementById(`tab-${tabName}-content`).classList.remove('hidden');
    document.getElementById(`tab-${tabName}-content`).classList.add('active');
    document.getElementById(`tab-${tabName}`).classList.add('active', 'border-blue-500', 'text-blue-600', 'dark:text-blue-400', 'dark:border-blue-400');
    document.getElementById(`tab-${tabName}`).classList.remove('border-transparent', 'text-gray-500', 'dark:text-gray-400');
}

// Asignar eventos a las pestañas
document.getElementById('tab-general').addEventListener('click', () => switchTab('general'));
document.getElementById('tab-evidencias').addEventListener('click', () => switchTab('evidencias'));
document.getElementById('tab-accesos').addEventListener('click', () => switchTab('accesos'));

// Función para mostrar detalles técnicos en un modal
function showTechnicalDetails(details) {
    const modal = document.getElementById('technicalDetailsModal');
    const textElement = document.getElementById('technicalDetailsText');
    
    // Convertir a string si es un objeto
    let detailsStr = typeof details === 'object' ? JSON.stringify(details, null, 2) : details;
    
    // Limpiar y formatear el string
    try {
        // Intentar parsear y volver a string para formatear
        const parsed = JSON.parse(detailsStr);
        detailsStr = JSON.stringify(parsed, null, 2);
    } catch (e) {
        // Si no es JSON válido, mostrar el contenido original
        console.warn('Los detalles técnicos no son JSON válido:', e);
    }

    // Mostrar en el elemento pre
    textElement.textContent = detailsStr;
    
    // Mostrar el modal
    modal.classList.remove('hidden');
    document.body.classList.add('overflow-hidden');
}

// Función para cerrar el modal de detalles técnicos
function closeTechnicalDetailsModal() {
    document.getElementById('technicalDetailsModal').classList.add('hidden');
    document.body.classList.remove('overflow-hidden');
}

// Función para cerrar el modal principal
function closeModal() {
    document.getElementById('evidenceModal').classList.add('hidden');
    document.body.classList.remove('overflow-hidden');
}


// Funciones para el modal de exportación
function openExportModal() {
    document.getElementById('exportModal').classList.remove('hidden');
    document.body.classList.add('overflow-hidden');
}

function closeExportModal() {
    document.getElementById('exportModal').classList.add('hidden');
    document.body.classList.remove('overflow-hidden');
}

// Función principal de exportación
function exportTable(format) {
    const filename = document.getElementById('exportFilename').value.trim() || 'reporte_urls_maliciosas';
    const tableId = 'urlsTable'; // Necesitamos agregar este ID a la tabla
    
    if (format === 'xlsx') {
        exportToExcel(tableId, filename);
    } else {
        exportToCSV(tableId, filename);
    }
    
    closeExportModal();
}

// Función para exportar a Excel (usando SheetJS)
function exportToExcel(tableID, filename = '') {
    // Verificar si SheetJS está disponible
    if (typeof XLSX === 'undefined') {
        alert('La biblioteca SheetJS no está cargada. Usando método alternativo...');
        exportToExcelBasic(tableID, filename);
        return;
    }
    
    const table = document.getElementById(tableID);
    if (!table) {
        console.error(`No se encontró la tabla con ID: ${tableID}`);
        return;
    }
    
    // Clonar la tabla para no modificar la original
    const clonedTable = table.cloneNode(true);
    
    // Eliminar la columna de Acciones
    clonedTable.querySelectorAll('tr').forEach(row => {
        const actionCell = row.querySelector('td:last-child, th:last-child');
        if (actionCell) actionCell.remove();
    });
    
    // Crear un libro de trabajo
    const wb = XLSX.utils.book_new();
    
    // Convertir la tabla clonada (sin acciones) a una hoja de trabajo
    const ws = XLSX.utils.table_to_sheet(clonedTable);
    
    // Añadir la hoja al libro
    XLSX.utils.book_append_sheet(wb, ws, "URLs Maliciosas");
    
    // Generar el archivo XLSX
    XLSX.writeFile(wb, `${filename}.xlsx`);
}

// Función alternativa para Excel (sin SheetJS)
function exportToExcelBasic(tableID, filename = '') {
    const table = document.getElementById(tableID);
    if (!table) {
        console.error(`No se encontró la tabla con ID: ${tableID}`);
        return;
    }

    // Obtener todas las filas de la tabla
    const rows = table.querySelectorAll('tr');
    const data = [];

    // Recorrer cada fila
    rows.forEach(row => {
        const rowData = [];
        // Obtener todas las celdas excepto la última (Acciones)
        const cells = row.querySelectorAll('th:not(:last-child), td:not(:last-child)');
        
        cells.forEach(cell => {
            // Limpiar el texto (remover iconos SVG, spans, etc.)
            const clone = cell.cloneNode(true);
            clone.querySelectorAll('svg, span, button').forEach(el => el.remove());
            rowData.push(clone.textContent.trim());
        });
        
        data.push(rowData.join('\t')); // TSV para Excel
    });

    const content = '\uFEFF' + data.join('\n'); // BOM para UTF-8
    const mimeType = 'application/vnd.ms-excel;charset=utf-8;';
    const finalFilename = `${filename}.xls`;
    
    // Crear el elemento de descarga
    const link = document.createElement('a');
    link.href = `data:${mimeType},${encodeURIComponent(content)}`;
    link.download = finalFilename;
    
    // Simular click para descargar
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Función para exportar a CSV (Versión corregida definitiva)
function exportToCSV(tableID, filename = '') {
    const table = document.getElementById(tableID);
    if (!table) {
        console.error(`No se encontró la tabla con ID: ${tableID}`);
        return;
    }

    // Obtener todas las filas de la tabla
    const rows = table.querySelectorAll('tr');
    const data = [];

    // Recorrer cada fila
    rows.forEach(row => {
        const rowData = [];
        // Obtener todas las celdas excepto la última (Acciones)
        const cells = row.querySelectorAll('th:not(:last-child), td:not(:last-child)');
        
        cells.forEach(cell => {
            // Solución especial para las celdas de Método e Impacto
            let text;
            
            // Verificar si es una celda de Método (contiene un span con clase bg-blue-100)
            const metodoSpan = cell.querySelector('span.bg-blue-100, span.bg-blue-900');
            if (metodoSpan) {
                text = metodoSpan.textContent.trim();
            } 
            // Verificar si es una celda de Impacto (contiene un span con clases de color)
            else if (cell.querySelector('span.bg-red-100, span.bg-orange-100, span.bg-yellow-100, span.bg-gray-100, span.bg-red-900, span.bg-orange-900, span.bg-yellow-900, span.bg-gray-700')) {
                const impactoSpan = cell.querySelector('span');
                text = impactoSpan.textContent.trim();
            }
            // Para otras celdas normales
            else {
                // Clonar para no afectar el DOM original
                const clone = cell.cloneNode(true);
                // Remover elementos que no queremos en el export
                clone.querySelectorAll('svg, button, span').forEach(el => el.remove());
                text = clone.textContent.trim();
            }
            
            // Asegurar que el texto no sea undefined/null
            const cleanText = text || '';
            
            // Escapar comillas para CSV
            rowData.push(`"${cleanText.replace(/"/g, '""')}"`);
        });
        
        // Solo agregar la fila si tiene datos (evita filas vacías)
        if (rowData.length > 0) {
            data.push(rowData.join(','));
        }
    });

    const content = data.join('\n');
    const mimeType = 'text/csv;charset=utf-8;';
    const finalFilename = `${filename}.csv`;
    
    // Crear el elemento de descarga
    const link = document.createElement('a');
    link.href = `data:${mimeType},${encodeURIComponent(content)}`;
    link.download = finalFilename;
    
    // Simular click para descargar
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Cerrar modal al hacer clic fuera
window.onclick = function(event) {
    const exportModal = document.getElementById('exportModal');
    if (event.target === exportModal) {
        closeExportModal();
    }
    
    // Mantener el resto de la función original
    const evidenceModal = document.getElementById('evidenceModal');
    const technicalModal = document.getElementById('technicalDetailsModal');
    
    if (event.target === evidenceModal) {
        closeModal();
    }
    
    if (event.target === technicalModal) {
        closeTechnicalDetailsModal();
    }
}

</script>
{% endblock contenido %}